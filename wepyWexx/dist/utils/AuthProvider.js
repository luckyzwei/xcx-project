'use strict';

var _api = require('./api.js');

var _api2 = _interopRequireDefault(_api);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var wxRequest = require('./wxRequest.js');


function onLogin(type, phoneNum, callback) {
    if (phoneNum) {
        //有手机号码就是第一次进来你，然后保存下来
        wx.setStorageSync('phoneNum', phoneNum);
    }
    var url = void 0,
        dataParams = void 0,
        tokenParams = void 0;
    if (type === 'sell') {
        url = _api2.default.getToken;
        tokenParams = null;
        dataParams = {
            phone: phoneNum || wx.getStorageSync('phoneNum'),
            id: wx.getStorageSync('unionid')
        };
    } else if (type === 'buy') {
        tokenParams = { type: 'Basic', value: _api2.default.SECRET };
        url = _api2.default.getTokenC + 'unionid_' + wx.getStorageSync('unionid') + '_type_2';
    }
    return wxRequest.fetch(url, tokenParams, dataParams, "POST").then(function (res) {
        if (res.data.resultCode === '100') {
            console.log('卖家鉴权');
            saveTokens(res.data.resultContent.access_token, res.data.resultContent.refresh_token, res.data.resultContent.expires_in);
            callback(res.data);
            return res.data.resultContent.access_token;
        } else if (res.data.resultCode === '02504046') {
            callback({ msg: '该用户不在白名单内', code: 404 });
        } else if (res.data.access_token) {
            console.log('买家鉴权');
            saveTokens(res.data.access_token, res.data.refresh_token, res.data.expires_in);
            return res.data.access_token;
        } else {
            callback({ msg: '异常错误', code: 304 });
        }
    }).catch(function (req) {
        callback({ msg: '请求出错', code: 502 });
        return 'error';
    });
}
function setWait() {
    wx.removeStorageSync('access_token');
}
function saveTokens(access_token, refresh_token, expires_in) {
    wx.setStorageSync('access_token', access_token);
    wx.setStorageSync('refresh_token', refresh_token);
    var exp = new Date();
    var expires_ins = exp.getTime() + expires_in * 1000 - 30000;
    wx.setStorageSync('expires_in', expires_ins);
}
function onRefreshToken() {
    setWait();
    var token = _api2.default.SECRET;
    var url = _api2.default.refreshToken + wx.getStorageSync('refresh_token');
    return wxRequest.fetch(url, { type: 'Basic', value: token }, '', 'POST').then(function (res) {
        if (res.data.access_token) {
            saveTokens(res.data.access_token, res.data.refresh_token, res.data.expires_in);
            return res.data.access_token;
        } else {
            return onLogin(wx.getStorageSync('userType'), null, function (res) {}).then(function (res) {
                return res;
            });
        }
    }).catch(function (req) {
        if (wx.getStorageSync('refresh_token') != null) {
            return onLogin(wx.getStorageSync('userType'), null, function (res) {}).then(function (res) {
                return res;
            });
        }
    });
}
function getAccessToken() {
    var date = new Date();
    var dt = date.getTime();
    var expires_in = wx.getStorageSync('expires_in');
    if ((!expires_in || dt >= expires_in) && wx.getStorageSync('access_token')) {
        return onRefreshToken();
    } else if (!wx.getStorageSync('access_token')) {
        return new Promise(function (resolve, reject) {
            setTimeout(function () {
                resolve(wx.getStorageSync('access_token'));
            }, 2000);
        });
    } else {
        return new Promise(function (resolve, reject) {
            resolve(wx.getStorageSync('access_token'));
        });
    }
}
module.exports = {
    onLogin: onLogin,
    getAccessToken: getAccessToken
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkF1dGhQcm92aWRlci5qcyJdLCJuYW1lcyI6WyJ3eFJlcXVlc3QiLCJyZXF1aXJlIiwib25Mb2dpbiIsInR5cGUiLCJwaG9uZU51bSIsImNhbGxiYWNrIiwid3giLCJzZXRTdG9yYWdlU3luYyIsInVybCIsImRhdGFQYXJhbXMiLCJ0b2tlblBhcmFtcyIsIkFQSSIsImdldFRva2VuIiwicGhvbmUiLCJnZXRTdG9yYWdlU3luYyIsImlkIiwidmFsdWUiLCJTRUNSRVQiLCJnZXRUb2tlbkMiLCJmZXRjaCIsInRoZW4iLCJyZXMiLCJkYXRhIiwicmVzdWx0Q29kZSIsImNvbnNvbGUiLCJsb2ciLCJzYXZlVG9rZW5zIiwicmVzdWx0Q29udGVudCIsImFjY2Vzc190b2tlbiIsInJlZnJlc2hfdG9rZW4iLCJleHBpcmVzX2luIiwibXNnIiwiY29kZSIsImNhdGNoIiwicmVxIiwic2V0V2FpdCIsInJlbW92ZVN0b3JhZ2VTeW5jIiwiZXhwIiwiRGF0ZSIsImV4cGlyZXNfaW5zIiwiZ2V0VGltZSIsIm9uUmVmcmVzaFRva2VuIiwidG9rZW4iLCJyZWZyZXNoVG9rZW4iLCJnZXRBY2Nlc3NUb2tlbiIsImRhdGUiLCJkdCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwic2V0VGltZW91dCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQ0E7Ozs7OztBQURBLElBQU1BLFlBQVlDLFFBQVEsYUFBUixDQUFsQjs7O0FBR0EsU0FBU0MsT0FBVCxDQUFpQkMsSUFBakIsRUFBdUJDLFFBQXZCLEVBQWlDQyxRQUFqQyxFQUEyQztBQUN2QyxRQUFJRCxRQUFKLEVBQWM7QUFDVjtBQUNBRSxXQUFHQyxjQUFILENBQWtCLFVBQWxCLEVBQThCSCxRQUE5QjtBQUNIO0FBQ0QsUUFBSUksWUFBSjtBQUFBLFFBQVNDLG1CQUFUO0FBQUEsUUFBcUJDLG9CQUFyQjtBQUNBLFFBQUlQLFNBQVMsTUFBYixFQUFxQjtBQUNqQkssY0FBTUcsY0FBSUMsUUFBVjtBQUNB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SCxDQUFrQixjQUFsQixDQUFMLEVBQXdDO0FBQzNDLGVBQU8sSUFBSWlDLE9BQUosQ0FBWSxVQUFDQyxPQUFELEVBQVVDLE1BQVYsRUFBcUI7QUFDcENDLHVCQUFXLFlBQU07QUFDYkYsd0JBQVExQyxHQUFHUSxjQUFILENBQWtCLGNBQWxCLENBQVI7QUFDSCxhQUZELEVBRUcsSUFGSDtBQUdILFNBSk0sQ0FBUDtBQUtILEtBTk0sTUFNQTtBQUNILGVBQU8sSUFBSWlDLE9BQUosQ0FBWSxVQUFDQyxPQUFELEVBQVVDLE1BQVYsRUFBcUI7QUFDcENELG9CQUFRMUMsR0FBR1EsY0FBSCxDQUFrQixjQUFsQixDQUFSO0FBQ0gsU0FGTSxDQUFQO0FBR0g7QUFDSjtBQUNEcUMsT0FBT0MsT0FBUCxHQUFpQjtBQUNibEQsYUFBU0EsT0FESTtBQUViMEMsb0JBQWdCQTtBQUZILENBQWpCIiwiZmlsZSI6IkF1dGhQcm92aWRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHd4UmVxdWVzdCA9IHJlcXVpcmUoJy4vd3hSZXF1ZXN0Jyk7XG5pbXBvcnQgQVBJIGZyb20gJy4vYXBpJztcblxuZnVuY3Rpb24gb25Mb2dpbih0eXBlLCBwaG9uZU51bSwgY2FsbGJhY2spIHtcbiAgICBpZiAocGhvbmVOdW0pIHtcbiAgICAgICAgLy/mnInmiYvmnLrlj7fnoIHlsLHmmK/nrKzkuIDmrKHov5vmnaXkvaDvvIznhLblkI7kv53lrZjkuIvmnaVcbiAgICAgICAgd3guc2V0U3RvcmFnZVN5bmMoJ3Bob25lTnVtJywgcGhvbmVOdW0pXG4gICAgfVxuICAgIGxldCB1cmwsIGRhdGFQYXJhbXMsIHRva2VuUGFyYW1zO1xuICAgIGlmICh0eXBlID09PSAnc2VsbCcpIHtcbiAgICAgICAgdXJsID0gQVBJLmdldFRva2VuO1xuICAgICAgICB0b2tlblBhcmFtcyA9IG51bGw7XG4gICAgICAgIGRhdGFQYXJhbXMgPSB7XG4gICAgICAgICAgICBwaG9uZTogcGhvbmVOdW0gfHwgd3guZ2V0U3RvcmFnZVN5bmMoJ3Bob25lTnVtJyksXG4gICAgICAgICAgICBpZDogd3guZ2V0U3RvcmFnZVN5bmMoJ3VuaW9uaWQnKVxuICAgICAgICB9XG4gICAgfSBlbHNlIGlmICgodHlwZSA9PT0gJ2J1eScpKSB7XG4gICAgICAgIHRva2VuUGFyYW1zID0geyB0eXBlOiAnQmFzaWMnLCB2YWx1ZTogQVBJLlNFQ1JFVCB9O1xuICAgICAgICB1cmwgPSBBUEkuZ2V0VG9rZW5DICsgJ3VuaW9uaWRfJyArIHd4LmdldFN0b3JhZ2VTeW5jKCd1bmlvbmlkJykgKyAnX3R5cGVfMic7XG4gICAgfVxuICAgIHJldHVybiB3eFJlcXVlc3QuZmV0Y2godXJsLCB0b2tlblBhcmFtcywgZGF0YVBhcmFtcywgXCJQT1NUXCIpLnRoZW4oKHJlcykgPT4ge1xuICAgICAgICBpZiAocmVzLmRhdGEucmVzdWx0Q29kZSA9PT0gJzEwMCcpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCfljZblrrbpibTmnYMnKTtcbiAgICAgICAgICAgIHNhdmVUb2tlbnMocmVzLmRhdGEucmVzdWx0Q29udGVudC5hY2Nlc3NfdG9rZW4sIHJlcy5kYXRhLnJlc3VsdENvbnRlbnQucmVmcmVzaF90b2tlbiwgcmVzLmRhdGEucmVzdWx0Q29udGVudC5leHBpcmVzX2luKTtcbiAgICAgICAgICAgIGNhbGxiYWNrKHJlcy5kYXRhKTtcbiAgICAgICAgICAgIHJldHVybiByZXMuZGF0YS5yZXN1bHRDb250ZW50LmFjY2Vzc190b2tlblxuICAgICAgICB9IGVsc2UgaWYgKHJlcy5kYXRhLnJlc3VsdENvZGUgPT09ICcwMjUwNDA0NicpIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKHsgbXNnOiAn6K+l55So5oi35LiN5Zyo55m95ZCN5Y2V5YaFJywgY29kZTogNDA0IH0pXG4gICAgICAgIH0gZWxzZSBpZiAocmVzLmRhdGEuYWNjZXNzX3Rva2VuKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygn5Lmw5a626Ym05p2DJyk7XG4gICAgICAgICAgICBzYXZlVG9rZW5zKHJlcy5kYXRhLmFjY2Vzc190b2tlbiwgcmVzLmRhdGEucmVmcmVzaF90b2tlbiwgcmVzLmRhdGEuZXhwaXJlc19pbik7XG4gICAgICAgICAgICByZXR1cm4gcmVzLmRhdGEuYWNjZXNzX3Rva2VuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjYWxsYmFjayh7IG1zZzogJ+W8guW4uOmUmeivrycsIGNvZGU6IDMwNCB9KVxuICAgICAgICB9XG4gICAgfSkuY2F0Y2goKHJlcSkgPT4ge1xuICAgICAgICBjYWxsYmFjayh7IG1zZzogJ+ivt+axguWHuumUmScsIGNvZGU6IDUwMiB9KTtcbiAgICAgICAgcmV0dXJuICdlcnJvcidcbiAgICB9KVxufVxuZnVuY3Rpb24gc2V0V2FpdCgpIHtcbiAgICB3eC5yZW1vdmVTdG9yYWdlU3luYygnYWNjZXNzX3Rva2VuJyk7XG59XG5mdW5jdGlvbiBzYXZlVG9rZW5zKGFjY2Vzc190b2tlbiwgcmVmcmVzaF90b2tlbiwgZXhwaXJlc19pbikge1xuICAgIHd4LnNldFN0b3JhZ2VTeW5jKCdhY2Nlc3NfdG9rZW4nLCBhY2Nlc3NfdG9rZW4pO1xuICAgIHd4LnNldFN0b3JhZ2VTeW5jKCdyZWZyZXNoX3Rva2VuJywgcmVmcmVzaF90b2tlbik7XG4gICAgdmFyIGV4cCA9IG5ldyBEYXRlKCk7XG4gICAgdmFyIGV4cGlyZXNfaW5zID0gZXhwLmdldFRpbWUoKSArIGV4cGlyZXNfaW4gKiAxMDAwIC0gMzAwMDA7XG4gICAgd3guc2V0U3RvcmFnZVN5bmMoJ2V4cGlyZXNfaW4nLCBleHBpcmVzX2lucyk7XG59XG5mdW5jdGlvbiBvblJlZnJlc2hUb2tlbigpIHtcbiAgICBzZXRXYWl0KCk7XG4gICAgbGV0IHRva2VuID0gQVBJLlNFQ1JFVDtcbiAgICB2YXIgdXJsID0gQVBJLnJlZnJlc2hUb2tlbiArIHd4LmdldFN0b3JhZ2VTeW5jKCdyZWZyZXNoX3Rva2VuJyk7XG4gICAgcmV0dXJuIHd4UmVxdWVzdC5mZXRjaCh1cmwsIHsgdHlwZTogJ0Jhc2ljJywgdmFsdWU6IHRva2VuIH0sICcnLCAnUE9TVCcpLnRoZW4oKHJlcykgPT4ge1xuICAgICAgICBpZiAocmVzLmRhdGEuYWNjZXNzX3Rva2VuKSB7XG4gICAgICAgICAgICBzYXZlVG9rZW5zKHJlcy5kYXRhLmFjY2Vzc190b2tlbiwgcmVzLmRhdGEucmVmcmVzaF90b2tlbiwgcmVzLmRhdGEuZXhwaXJlc19pbik7XG4gICAgICAgICAgICByZXR1cm4gcmVzLmRhdGEuYWNjZXNzX3Rva2VuO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG9uTG9naW4od3guZ2V0U3RvcmFnZVN5bmMoJ3VzZXJUeXBlJyksIG51bGwsIHJlcyA9PiB7IH0pLnRoZW4ocmVzID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0pLmNhdGNoKHJlcSA9PiB7XG4gICAgICAgIGlmICh3eC5nZXRTdG9yYWdlU3luYygncmVmcmVzaF90b2tlbicpICE9IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVybiBvbkxvZ2luKHd4LmdldFN0b3JhZ2VTeW5jKCd1c2VyVHlwZScpLCBudWxsLCByZXMgPT4geyB9KS50aGVuKHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9KVxufVxuZnVuY3Rpb24gZ2V0QWNjZXNzVG9rZW4oKSB7XG4gICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSgpO1xuICAgIHZhciBkdCA9IGRhdGUuZ2V0VGltZSgpO1xuICAgIHZhciBleHBpcmVzX2luID0gd3guZ2V0U3RvcmFnZVN5bmMoJ2V4cGlyZXNfaW4nKTtcbiAgICBpZiAoKCFleHBpcmVzX2luIHx8IGR0ID49IGV4cGlyZXNfaW4pICYmIHd4LmdldFN0b3JhZ2VTeW5jKCdhY2Nlc3NfdG9rZW4nKSkge1xuICAgICAgICByZXR1cm4gb25SZWZyZXNoVG9rZW4oKTtcbiAgICB9IGVsc2UgaWYgKCF3eC5nZXRTdG9yYWdlU3luYygnYWNjZXNzX3Rva2VuJykpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJlc29sdmUod3guZ2V0U3RvcmFnZVN5bmMoJ2FjY2Vzc190b2tlbicpKVxuICAgICAgICAgICAgfSwgMjAwMClcbiAgICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgcmVzb2x2ZSh3eC5nZXRTdG9yYWdlU3luYygnYWNjZXNzX3Rva2VuJykpXG4gICAgICAgIH0pXG4gICAgfVxufVxubW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgb25Mb2dpbjogb25Mb2dpbixcbiAgICBnZXRBY2Nlc3NUb2tlbjogZ2V0QWNjZXNzVG9rZW5cbn0iXX0=